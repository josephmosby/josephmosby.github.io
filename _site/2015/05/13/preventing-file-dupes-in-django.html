<!doctype html>
<html>
	<head>

		<title>josephmosby.com</title>
		<meta http-equiv="Content-Type" content="text/html" charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="/stylesheets/fibonacci.css" />
		<link rel="stylesheet" href="/stylesheets/custom.css" />

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

	</head>

	<body>

		<div class="wrapper" id="header">
			<div class="container">
				<div class="row">
					<div class="col-13">
						<a href="/"><h3>JOSEPH MOSBY</h3></a>

						<ul class="menu inline">
							<li><a href="/about">about</a></li>
							<li><a href="/projects">projects</a></li>
							<li><a href="/presentations">presentations</a></li>
							<li><a href="/now">now</a></li>
							<li><a href="/feed/atom.xml">subscribe</a></li>
						</ul>

						<a id="hamburger" href="#">MENU</a>
					</div>
				</div>
			</div>
		</div>

		<div class="wrapper" id="dropdown">
			<div class="container">
				<div class="row">
					<div class="col-13">
						<ul class="menu dropdown">
							<li><a href="/about">about</a></li>
							<li><a href="/projects">projects</a></li>
							<li><a href="/presentations">presentations</a></li>
							<li><a href="/now">now</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>

		<div class="wrapper" id="main">
			<div class="container">
				<div class="row">
	<div class="col-3">
		<a href="/2015/05/13/preventing-file-dupes-in-django.html"><h3>Preventing file dupes in files uploaded through Django</h3></a>
	</div>
	<div class="col-8">
		<p>Many Django applications make use of uploaded files that should never be re-uploaded again after they’ve been uploaded once. An example of this in action might be an image (one image embedded in a blog post might not be a big deal for a small site, but news sites often deal with licensed high-definition images used across several stories) or a large PDF with associated metadata (once the metadata is keyed in once, users shouldn’t be asked to do so again). Let’s talk about two design patterns to handle files, and ways we can deal with duplicates in each one. </p>

<h3 id="the-attachment">The Attachment</h3>

<p>With the Attachment design pattern, a file is part of the model as a Django <a href="https://docs.djangoproject.com/en/1.8/ref/models/fields/#django.db.models.FileField">FileField</a>. This is useful if the file to be attached is known ahead of time and will be of a semi-predictable type (for example, a press release for a scheduled report that will be in PDF format). Two or three additional users may be writing blog posts on the report, and each of them plan to attach the report as well. We don’t want to store a stack of extra copies of the file on the server - so how can we de-dupe them?</p>

<p>Our post is set up like so:</p>

<pre><code>from django.db import models

class ReportPost(models.Model):
	file = models.FileField()
	file_sha1 = models.CharField(max_length=40)
	post_text = models.TextField()

	... etc ...
</code></pre>

<p>Our <code>ReportPost</code> has space for an uploaded file. We also have a <code>sha1</code> field here. Django can’t automatically detect a duplicate file (<code>unique</code> is not supported for <code>FileFields</code> or any derivatives), so we need to take the SHA-1 text hash of the file in order to check if it’s been uploaded already. We’ll take care of that in the <code>ModelAdmin</code> for this model.</p>

<pre><code>from django.contrib import admin
import hashlib

def generate_sha(file):
	sha = hashlib.sha1()
	file.seek(0)
	while True:
		buf = file.read(104857600)
		if not buf:
			break
		sha.update(buf)
	sha1 = sha.hexdigest()
	file.seek(0)

	return sha1

class ReportPostAdmin(admin.ModelAdmin):
	... stuff ...

	def save_model(self, request, obj, form, change):
		sha = generate_sha(obj.file)
		obj.file_sha1 = sha
		match_qs = ReportPost.objects.filter(file_sha1=sha)
		if match_qs.count() &gt; 0:
			obj.file = match_qs[0].file

		obj.save()
</code></pre>

<p>We derive a SHA-1 hash for this file by reading in the first 100 megabytes of data and hashing it. In our <code>ModelAdmin.save_model</code> method, we store that SHA-1 with our model instance. We also run a query against the database for any model instances with that exact same SHA-1 (indicating a match), and replace our instance of the file with the previously uploaded file. </p>

<h3 id="the-file-as-object">The File as Object</h3>

<p>With this design pattern, files are part of a larger object that gives them relevance. Images in a newsroom app, for example, come with credits, licensing information, and various data about how often the image is used. In order to store that metadata about that image, we need a file object.</p>

<pre><code># models.py

class ImageObject(models.Model):
	caption = models.CharField(max_length=140)
	credits = models.CharField(max_length=140)
	image_file = models.ImageField()
	file_sha1 = models.CharField(max_length=40, unique=True)

# admin.py

class ImageObjectAdmin(admin.ModelAdmin):
	... stuff ...

	def save_model(self, request, obj, form, change):
		sha = generate_sha(obj.file)
		obj.file_sha1 = sha
		obj.save()
</code></pre>

<p>With this example, we add some uniqueness to our model, which gives us the ability to easily enforce that each image file will only have one set of metadata. Our app will throw an <code>IntegrityError</code> if a user tries to save a duplicate SHA-1 hash. We’ll need to handle that <code>IntegrityError</code> and redirect our user to the previously uploaded image. We can do that using a new middleware object.</p>

<p>Middleware objects in Django quietly do their thing 99.9% of the time, and you’ll never think twice about them. They’re there for session authentication or CSRF enforcement - things that most of us take for granted. But you can easily add your own middleware with ease by adding a <code>middleware.py</code> file to your application and registering it with <code>settings.py</code>:</p>

<pre><code># settings.py

MIDDLEWARE_CLASSES = (
	'django.contrib.sessions.middleware.SessionMiddleware',
	... stuff ...
	'our_image_app.middleware.RedirectOnSHAViolation',
)
</code></pre>

<p>And then in <code>our_image_app/middleware.py</code>:</p>

<pre><code># middleware.py

from django.db import IntegrityError
from django.http import HttpResponseRedirect
from utils import generate_sha # same func as before
from our_image_app.models import ImageObject

class RedirectOnSHAViolation():
	def process_exception(self, request, exception):
		if type(exception) == IntegrityError:
			if "our_image_app/imageobject" in request.path:
				sha1 = generate_sha1(request.FILES['image_file'])
				img = ImageObject.objects.get(file_sha1=sha1)
				return HttpResponseRedirect('/admin/our_image_app/imageobject/') + str(img.id))
</code></pre>

<p>I never said it was pretty.</p>

<p>Django’s middleware system expects to see a class with a <code>process_exception</code> method that’s really, really stupid. The middleware knows it has a request that caused an error, but that’s about all that it knows. We have to do two checks to make sure that we’re handling the right error here. First, we check that the <code>type</code> of error is <code>IntegrityError</code>. We have to run this check first because every single error in our app could potentially hit this method, so we need to filter for only certain types. Once I’ve confirmed that, I check to see if the <code>IntegrityError</code> came from the <code>ImageObject</code> model within <code>our_image_app</code> - and since <code>ImageObject</code> only has one unique field, I know an <code>IntegrityError</code> here must be a duplicate file. Once I’ve ascertained all of that, then I need to find the file I should have used and redirect the user there instead.</p>

<h3 id="conclusions">Conclusions</h3>

<p>SHA-1 hashes provide an easy way to compensate for Django FileFields’ inability to enforce uniqueness by default. Handling those errors can be a bit messy, but we can create some custom middleware to handle any problems or extend our admin’s built-in methods to help us out.</p>

<p><em>Props to <a href="https://twitter.com/spiggy">@spiggy</a>, who had the original idea of using SHAs to look for duplicate files.</em></p>

		<a class="twitter-share-button" href="http://twitter.com/share" data-url="http://josephmosby.com/2015/05/13/preventing-file-dupes-in-django.html" data-via="josephmosby">Tweet</a>
	</div>
</div>
			</div>
		</div>

		<div class="wrapper" id="footer">
			<div class="container">
				<div class="row">
					<div class="col-13">
						<p>Brought to you live from Washington, D.C.</p>
					</div>
				</div>
			</div>
		</div>

		<script src="app.js"></script>

		<script>
	
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-45638065-1', 'josephmosby.com');
	    ga('send', 'pageview');
	  
	  	</script>

  		<script>
		window.twttr=(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return;js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);t._e=[];t.ready=function(f){t._e.push(f);};return t;}(document,"script","twitter-wjs"));
		</script>

	</body>

</html>