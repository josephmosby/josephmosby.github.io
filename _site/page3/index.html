<!doctype html>
<html>
	<head>

		<title>josephmosby.com</title>
		<meta http-equiv="Content-Type" content="text/html" charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="/stylesheets/fibonacci.css" />
		<link rel="stylesheet" href="/stylesheets/custom.css" />

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

	</head>

	<body>

		<div class="wrapper" id="header">
			<div class="container">
				<div class="row">
					<div class="col-13">
						<a href="/"><h3>JOSEPH MOSBY</h3></a>

						<ul class="menu inline">
							<li><a href="/about">about</a></li>
							<li><a href="/projects">projects</a></li>
							<li><a href="/presentations">presentations</a></li>
							<li><a href="/now">now</a></li>
							<li><a href="/feed/atom.xml">subscribe</a></li>
						</ul>

						<a id="hamburger" href="#">MENU</a>
					</div>
				</div>
			</div>
		</div>

		<div class="wrapper" id="dropdown">
			<div class="container">
				<div class="row">
					<div class="col-13">
						<ul class="menu dropdown">
							<li><a href="/about">about</a></li>
							<li><a href="/projects">projects</a></li>
							<li><a href="/presentations">presentations</a></li>
							<li><a href="/now">now</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>

		<div class="wrapper" id="main">
			<div class="container">
				
<div class="row">
	<div class="col-3">
		<a href="/2015/10/16/up-and-running-with-flask-on-a-brand-new-linode.html"><h3>Up and Running with Flask on a Brand New Linode</h3></a>
		<div class="date">October 16, 2015</div>
	</div>
	<div class="col-8">
		<p>Tonight, I’m building a minimalistic Flask app that will run on Linode. Flask is a relatively new framework for me. I’ve dealt with CentOS, nginx, and uwsgi at work, but I’ve never tried to get them installed on my own. Time to get started.</p>

<h3 id="step-1-install-and-configure-nginx-round-1">Step 1: Install and configure nginx, round 1</h3>

<p>I am skipping over the step where we create a CentOS 7 machine from the Linode dashboard. I can’t think of a good way to explain that one without screenshots. Let’s assume we have one, and let’s install the necessaries on it.</p>

<pre><code>$ yum install epel-release
$ yum install nginx
</code></pre>

<p>Okay! That was simple enough. Here we’ve installed nginx, which will allow us to serve up our web pages. I want to start here because I like the feedback of knowing that I’m serving up web pages from the very start.</p>

<p>I know that I plan to serve multiple sites off of this one server, so I need to adjust my domain and nginx configuration accordingly. In Namecheap, I’ve created 2 A records - dashboard.mosby.io and www.mosby.io - which I’ll both point at this server’s IP address. I’ll let nginx sort out the parsing.</p>

<pre><code># /etc/nginx/nginx.conf

... # stuff here that you shouldn't remove

http {

	... # more stuff here that you shouldn't remove

	server { 
		listen	80;
		server_name	www.mosby.io;
		root /var/www/main;
	}

	server {
		listen	80;
		server_name	dashboard.mosby.io;
		root /var/www/dashboard;
	}
}
</code></pre>

<p>nginx has a configuration file called <code>nginx.conf</code> that we’re going to modify to serve our sites. Here, we’ve said that any request incoming will either be for <code>www.mosby.io</code> or <code>dashboard.mosby.io</code>. If it’s for <code>www</code>, we’re going to serve content from <code>/var/www/main</code>. If it’s for <code>dashboard</code>, we’re going to serve content from <code>/var/www/dashboard</code>. We can test this out by creating two text files:</p>

<pre><code># /var/www/main/index.html

Hello, www.mosby.io!
</code></pre>

<p>AND</p>

<pre><code># /var/www/dashboard/index.html

Hello, dashboard.mosby.io!
</code></pre>

<p>Assuming that you’ve already pointed your two subdomain to your Linode’s IP address, these will each display their respective content. Success!</p>

<h3 id="step-2-install-python3-flask-and-uwsgi">Step 2: Install Python3, Flask and uWSGI</h3>

<p>This is the part I know least about this entire process. Let’s start by installing Python 3, pip, and a version of <code>virtualenv</code> that’s cool with all of this:</p>

<pre><code>$ yum install python34
$ wget https://bootstrap.pypa.io/get-pip.py
$ python3.4 get-pip.py
</code></pre>

<p>Now I’m going to move into my dashboard folder and create the application. </p>

<pre><code>$ cd /var/www/dashboard
$ virtualenv venv
$ source venv/bin/activate
</code></pre>

<p>We’ve got a local instance of Python3 and pip now. Time to get uWSGI and Flask.</p>

<pre><code>$ pip install uwsgi flask
</code></pre>

<p>Wait hold on. uWSGI just crapped out on installation. I missed something. The scary error message looks like this:</p>

<pre><code>Command "/var/www/dashboard/venv/bin/python3.4 -c "import setuptools, tokenize;__file__='/tmp/pip-build-5a_chnf_/uwsgi/setup.py';exec(compile(getattr(tokenize, 'open', open)(__file__).read().replace('\r\n', '\n'), __file__, 'exec'))" install --record /tmp/pip-8zr4gl3_-record/install-record.txt --single-version-externally-managed --compile --install-headers /var/www/dashboard/venv/include/site/python3.4/uwsgi" failed with error code 1 in /tmp/pip-build-5a_chnf_/uwsgi
</code></pre>

<p>But that’s not the root of the problem. I’ve got to scroll up the stack trace for that.</p>

<pre><code>In file included from plugins/python/python_plugin.c:1:0:
plugins/python/uwsgi_python.h:2:20: fatal error: Python.h: No such file or directory
 #include &lt;Python.h&gt;
</code></pre>

<p>I don’t have Python headers installed on this system! Let’s see if I can do that.</p>

<pre><code>$ yum install python34-devel
$ pip install uwsgi flask
</code></pre>

<p>Okay, that worked!</p>

<p>And now, let’s convert our little test HTML from before into a Flask app. We’re then going to remove the HTML file, which will let us confirm that we’ve actually set of Flask and uWSGI correctly when we see it again. I’m going to do some work here using the <code>vi</code> editor, but if you’re not familiar with it, please replace the <code>vi</code> commands with <code>nano</code>. It’s simpler.</p>

<pre><code>$ vi app.py

from flask import Flask
application = Flask(__name__)

@application.route("/")
def helloworld():
	return "Hello, dashboard.mosby.io on Flask!"

if __name__ == "__main__":
	application.run(host='0.0.0.0')

$ rm index.html
$ python app.py
</code></pre>

<p>I can see that I’ve done it all right by going to my new homepage in my browser! Visiting dashboard.mosby.io:5000 will show me my updated page. </p>

<h3 id="step-3-configure-uwsgi-serving">Step 3: Configure uWSGI Serving</h3>

<p>We’ve got ourselves a basic skin of an application, so let’s hook it up to nginx through uWSGI.</p>

<pre><code>$ uwsgi --socket 0.0.0.0:5000 --protocol=http -w wsgi
</code></pre>

<p>It works! Exactly the same way it did when we ran the application directly. Let’s build a <code>.ini</code> file so we can do this more repeatedly.</p>

<pre><code>$ vi dashboard.ini

[uwsgi]
module = wsgi

master = true
processes = 5

uid = ghost
socket = dashboard.sock
chown-socket = ghost:nginx
chmod-socket = 660
vacuum = true

die-on-term = true
</code></pre>

<p>This <code>ini</code> file does a few things for us. It points to the wsgi module, sets it in master mode, and spawns 5 processes of the app. It also ties to the uWSGI process to a Unix socket, and will remove (vacuum) that socket when the process stops.</p>

<p>I’m also specifying that the <code>ghost</code> user will own this process. (I’ve been doing all of this work as <code>root</code>, which is not a good practice for running the application) I now need to create the ghost user and add it to the nginx group.</p>

<pre><code>$ useradd ghost
$ usermod -a -G nginx ghost
</code></pre>

<p>Verify that you did it right:</p>

<pre><code>$ id ghost
</code></pre>

<p>You should see the <code>ghost</code> user attached to the nginx group. Onward!</p>

<h3 id="step-4-start-on-boot">Step 4: Start on Boot</h3>

<p>When our server comes online, we want our uWSGI app to be available immediately. Let’s start by creating a service file in our <code>/etc/systemd/system</code> directory.</p>

<pre><code>$ vi /etc/systemd/system/dashboard.service

[Unit]
Description=uwsgi instance to serve dashboard
After=network.target

[Service]
User=ghost
Group=nginx
WorkingDirectory=/var/www/dashboard
Environment="PATH=/var/www/dashboard/venv/bin"
ExecStart=/var/www/dashboard/venv/bin/uwsgi --ini dashboard.ini

[Install]
WantedBy=multi-user.target
</code></pre>

<p>There is black magic going on here that I need to dig into more. I don’t know <em>why</em> we do all of these things, but I do know that we’re specifying the working directory, and the environment, and what should happen when we start things up. Which we’ll do now.</p>

<pre><code>$ systemctl start dashboard
$ systemctl enable dashboard
</code></pre>

<h3 id="step-5-proxy-requests-from-nginx">Step 5: Proxy Requests from Nginx</h3>

<p>Now it’s time that we return to our <code>nginx.conf</code> file. We need to modify our dashboard server block to handle the uwsgi application.</p>

<pre><code># /etc/nginx/nginx.conf

... # stuff here that you shouldn't remove

http {

	... # more stuff here that you shouldn't remove

	server { 
		listen	80;
		server_name	www.mosby.io;
		root /var/www/main;
	}

	server {
		listen	80;
		server_name	dashboard.mosby.io;
		
		location / {
			include uwsgi_params;
			uwsgi_pass unix:/var/www/dashboard/dashboard.sock;
		}
	}
}

$ nginx -t &lt;-- test your configuration
$ service nginx reload
</code></pre>

<p>And now we go to our browser and punch in dashboard.mosby.io, and… crap.</p>

<p>502 Bad Gateway. What did I do wrong here? That error means nginx can’t talk to our application.</p>

<p>Ahh, I’ve been doing all this as root. Everything is currently owned by root, which means that neither <code>ghost</code> nor <code>nginx</code> can see my dashboard socket. Let’s change that. </p>

<pre><code>$ chown ghost:nginx /var/www/dashboard
$ service nginx reload
$ systemctl restart dashboard
</code></pre>

<p>And, we’re back, folks!</p>

<p>That’s a basic configuration for getting an Flask/uWSGI/nginx app up and running on a CentOS Linode box. If you decide to do something other than CentOS, most of it should still work, but the initialization service script will probably not. You can browse the repository for all of this <a href="https://github.com/josephmosby/dashboard/tree/c776c8875f8eaf094e2c506e1c0aca91693b7323">here</a>.</p>

		<a class="twitter-share-button" href="http://twitter.com/share" data-url="http://josephmosby.com/2015/10/16/up-and-running-with-flask-on-a-brand-new-linode.html" data-via="josephmosby">Tweet</a>
	</div>
</div>

<div class="row">
	<div class="col-3">
		<a href="/2015/08/17/pygotham-15-building-an-alu.html"><h3>PyGotham '15 - Building an ALU</h3></a>
		<div class="date">August 17, 2015</div>
	</div>
	<div class="col-8">
		<p>Really had an awesome time at PyGotham 2015! The organization is phenomenal and really made a fellow East Coaster feel welcome. </p>

<p>Talk is here: <a href="http://www.pyvideo.org/video/3784/modeling-an-arithmetic-logic-unit-in-python">http://www.pyvideo.org/video/3784/modeling-an-arithmetic-logic-unit-in-python</a></p>

<p>And slides are here: <a href="http://josephmosby.com/presentations/pygotham2015">http://josephmosby.com/presentations/pygotham2015</a></p>

<p>Example code is here: <a href="http://josephmosby.com/presentations/pygotham2015/chip_functions.py">http://josephmosby.com/presentations/pygotham2015/chip_functions.py</a></p>

		<a class="twitter-share-button" href="http://twitter.com/share" data-url="http://josephmosby.com/2015/08/17/pygotham-15-building-an-alu.html" data-via="josephmosby">Tweet</a>
	</div>
</div>

<div class="row">
	<div class="col-3">
		<a href="/2015/08/03/pyohio-15-production-django.html"><h3>PyOhio '15 - Production Django</h3></a>
		<div class="date">August 03, 2015</div>
	</div>
	<div class="col-8">
		<p>Over the weekend, I gave a talk at PyOhio 2015 on Production Django applications. Due to the tireless efforts of the video staff, that talk is already available online less than 24 hours later.</p>

<p>Talk is here: <a href="http://www.pyvideo.org/video/3712/production-django-building-a-highly-scalable-se">http://www.pyvideo.org/video/3712/production-django-building-a-highly-scalable-se</a></p>

<p>And slides are here: <a href="http://josephmosby.com/presentations/pyohio2015">http://josephmosby.com/presentations/pyohio2015</a></p>

<p>Special thanks to <a href="http://roberttownley.com/">Robert Townley</a> who gave pre-con feedback and <a href="http://juliangindi.com/">Julian Gindi</a> who gave an earlier talk that inspired some of the material. </p>

		<a class="twitter-share-button" href="http://twitter.com/share" data-url="http://josephmosby.com/2015/08/03/pyohio-15-production-django.html" data-via="josephmosby">Tweet</a>
	</div>
</div>

<div class="row">
	<div class="col-3">
		<a href="/2015/07/18/trusting-python-and-the-ken-thompson-hack.html"><h3>Trusting Python&comma; and the Ken Thompson hack</h3></a>
		<div class="date">July 18, 2015</div>
	</div>
	<div class="col-8">
		<p>I have always treated Python compilation as a black box. Code goes in, web services come out, everyone is happy. Then I went through <a href="http://www.nand2tetris.org/">NAND2Tetris</a> and picked up a copy of <a href="http://www.amazon.com/Programming-Language-Brian-W-Kernighan/dp/0131103628/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1437243255&amp;sr=1-1&amp;keywords=the+c+programming+language">The C Programming Language</a>, and it’s been tough to rest as easy ever since. </p>

<p>Python (in its most common derivative, CPython) is not fed straight into a computer’s processor. It’s first “interpreted” into C code, which is then compiled by a C compiler into assembly language, which is then translated into 1’s and 0’s that the computer can actually understand. Let’s take a look at this: </p>

<pre><code>print('Hello, world!')
</code></pre>

<p>That’s the incredibly simple Python code for printing “Hello, world!” Here’s what that looks like in the Python source code:</p>

<pre><code>static PyObject *
builtin_print(PyObject *self, PyObject *args, PyObject *kwds)
{
    static char *kwlist[] = {"sep", "end", "file", "flush", 0};
    static PyObject *dummy_args;
    PyObject *sep = NULL, *end = NULL, *file = NULL, *flush = NULL;
    int i, err;

    if (dummy_args == NULL &amp;&amp; !(dummy_args = PyTuple_New(0)))
        return NULL;
    if (!PyArg_ParseTupleAndKeywords(dummy_args, kwds, "|OOOO:print",
                                     kwlist, &amp;sep, &amp;end, &amp;file, &amp;flush))
        return NULL;
    if (file == NULL || file == Py_None) {
        file = _PySys_GetObjectId(&amp;PyId_stdout);
        if (file == NULL) {
            PyErr_SetString(PyExc_RuntimeError, "lost sys.stdout");
            return NULL;
        }

        /* sys.stdout may be None when FILE* stdout isn't connected */
        if (file == Py_None)
            Py_RETURN_NONE;
    }

    if (sep == Py_None) {
        sep = NULL;
    }
    else if (sep &amp;&amp; !PyUnicode_Check(sep)) {
        PyErr_Format(PyExc_TypeError,
                     "sep must be None or a string, not %.200s",
                     sep-&gt;ob_type-&gt;tp_name);
        return NULL;
    }
    if (end == Py_None) {
        end = NULL;
    }
    else if (end &amp;&amp; !PyUnicode_Check(end)) {
        PyErr_Format(PyExc_TypeError,
                     "end must be None or a string, not %.200s",
                     end-&gt;ob_type-&gt;tp_name);
        return NULL;
    }

    for (i = 0; i &lt; PyTuple_Size(args); i++) {
        if (i &gt; 0) {
            if (sep == NULL)
                err = PyFile_WriteString(" ", file);
            else
                err = PyFile_WriteObject(sep, file,
                                         Py_PRINT_RAW);
            if (err)
                return NULL;
        }
        err = PyFile_WriteObject(PyTuple_GetItem(args, i), file,
                                 Py_PRINT_RAW);
        if (err)
            return NULL;
    }

    if (end == NULL)
        err = PyFile_WriteString("\n", file);
    else
        err = PyFile_WriteObject(end, file, Py_PRINT_RAW);
    if (err)
        return NULL;

    if (flush != NULL) {
        PyObject *tmp;
        int do_flush = PyObject_IsTrue(flush);
        if (do_flush == -1)
            return NULL;
        else if (do_flush) {
            tmp = _PyObject_CallMethodId(file, &amp;PyId_flush, "");
            if (tmp == NULL)
                return NULL;
            else
                Py_DECREF(tmp);
        }
    }

    Py_RETURN_NONE;
}
</code></pre>

<p>I understand very little of what’s actually going on here. I do know that ultimately this code has to end up at some sort of terminal output unless I specify otherwise, and I do know that I’ll probably do that by writing to a dedicated terminal output memory location which is probably specified by a C pointer, and this is the extent of my understanding. And we haven’t even made it to assembly code yet. Or to binary instructions. </p>

<p>I go on trusting the CPython interpreter because I have no choice. Perhaps the <code>PyArg_ParseTupleAndKeywords</code> function has a side effect of batching my printed output up and sending it back to a Python mailing list somewhere, for them to laugh at my coding mistakes. Maybe it’s something more nefarious. </p>

<p>I can look through the CPython source code and see that <code>PyArg_ParseTupleAndKeywords</code> does exactly what it says it’s going to. But what if the <em>C compiler itself</em> is batching my printed output up and sending it off? In 1984 Ken Thompson described <a href="http://c2.com/cgi/wiki?TheKenThompsonHack">exactly that</a> with a hack that would allow a compiler to do all sorts of terrible things, including overwriting all evidence of its existence. You could detect it, of course, but you’d have to have a trusted compiler - something that most 2015 developers are not prepared to write. (myself included)</p>

<p>And so I have to trust my computer. I have to trust Intel, Apple, all of the component manufacturers, the <code>gcc</code> team, the CPython team, and everybody in between, because I am not prepared to compute otherwise. </p>

		<a class="twitter-share-button" href="http://twitter.com/share" data-url="http://josephmosby.com/2015/07/18/trusting-python-and-the-ken-thompson-hack.html" data-via="josephmosby">Tweet</a>
	</div>
</div>

<div class="row">
	<div class="col-3">
		<a href="/2015/07/14/the-uncomfortable-reality-of-software-engineering.html"><h3>The uncomfortable reality of software engineering</h3></a>
		<div class="date">July 14, 2015</div>
	</div>
	<div class="col-8">
		<p>I am haunted by the idea that someone will have to go back and make changes to certain pieces of code that I wrote in the past. The last time that actually happened was on a project that was originally set up as a demo, rife with technical debt as non-technical managers made rapid changes to requirements and promised clients they’d have something to show that same day. Enough of those types of changes and your project suddenly turns into a duck-taped train wreck. No one can read your code and understand how it works, and eventually, you can’t do it either.</p>

<p>I chat with software engineers in all manner of disciplines and this reality is very much the same. Maybe it’s because engineers are working with a management team that doesn’t want to take the time to do things right, but sometimes it’s due to a tired engineer who didn’t sleep well the night before and just wants to find the first fix for a bug that will get him home by 5:30pm. Sometimes it’s more insidious: individually, every feature might have been put into place with proper consideration, but an edge case causes a catastrophic failure once it runs through all of the machinery. </p>

<p>You don’t see that edge case ever properly discussed in the news. It’s too nuanced to make a good story for the general public, and companies are reticent to talk about major problems with their software. Neither <a href="http://www.wired.com/2015/07/united-airlines-flights-grounded-across-us-2nd-time/">United Airlines</a> nor <a href="http://www.wired.com/2015/07/nyse-halts-trading/">NYSE</a> have given any sort of technical reasons for their major glitches last week, but that says a whole lot in and of itself: it wasn’t some sort of concerted cyberterrorist attack, it was just an edge case that finally hit the software where it shouldn’t. Maybe it was just that <a href="http://stackoverflow.com/questions/4456438/how-do-i-correctly-pass-the-string-null-an-employees-proper-surname-to-a-so">Mr. Null</a> booked his first ever United Airlines flight.</p>

<p>Maybe this is all a reality of software engineering and will be forever, but I doubt that. I think we as engineers are approaching our <a href="http://abcnews.go.com/Business/story?id=87293">Arthur Andersen</a> moment. That point where we try to hold our hands up and say that we did what was expected of us and couldn’t possibly do more, but the world will disagree with us. Maybe it’s time we started thinking about how to prevent that moment before it happens because our stakes are much, much higher than the accounting profession’s. No one died because Enron fudged some numbers. They might die if one of those software bugs hits something important: something like an airline.</p>

		<a class="twitter-share-button" href="http://twitter.com/share" data-url="http://josephmosby.com/2015/07/14/the-uncomfortable-reality-of-software-engineering.html" data-via="josephmosby">Tweet</a>
	</div>
</div>

<div class="row">
	<div class="col-3">
		<a href="/2015/06/23/a-good-cs-undergraduate-algorithm-problem.html"><h3>A good CS undergraduate algorithm problem</h3></a>
		<div class="date">June 23, 2015</div>
	</div>
	<div class="col-8">
		<p>Okay, here’s a question for an undergraduate algorithms class to solve. In a non-relational database, we have a users collection with user preferences for breaking news alerts. In a separate collection, we have news stories with tags and searchable content. We will run a scheduled job that will pair the two and send news alerts to users if a story that matches their alert preferences has been published in the last half hour. </p>

<p>Given that we have approximately 50,000 users with an average of 5 alerts each and 500,000 stories with an average of 20 topics each and ten paragraphs of searchable content, how do we build this job in a way that it won’t crash the database?</p>

<p>Example tables:</p>

<p>users:</p>

<pre><code>[
	{ 
		email: "jane.doe@example.com",
		alerts: [
			{
				type: "open-search",
				term: "Barack Obama"
			},
			{
				type: "topic",
				term: "politics"
			},
			{
				type: "topic",
				term: "congress"
			},
			{
				type: "open-search",
				term: "natural gas"
			},
			{
				type: "open-search",
				term: "solar power"
			}
		]
	},
	{ 
		email: "john.smith@example.com",
		alerts: [
			{
				type: "open-search",
				term: "Joe Biden"
			},
			{
				type: "topic",
				term: "politics"
			},
			{
				type: "open-search",
				term: "sunglasses"
			},
			{
				type: "topic",
				term: "house"
			},
			{
				type: "topic",
				term: "senate"
			},
			{
				type: "open-search",
				term: "solar power"
			}
		]
	},

	....
]
</code></pre>

<p>stories:</p>

<pre><code>[
	{ 
		headline: "The Standard Lorem Ipsum passage",
		content: "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.......",
		tags: [
			{
				term: "Barack Obama"
			},
			{
				term: "president"
			},
			{
				term: "America"
			}
		]
	},
	{ 
		headline: "More lorem ipsum passages",
		content: "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.......",
		tags: [
			{
				term: "Joe Biden"
			},
			{
				term: "vice president"
			},
			{
				term: "Senate"
			}
		]
	},
]
</code></pre>

<p>The end result should look something like:</p>

<p>alerts:</p>

<pre><code>[
	{ 
		email: 'john.doe@example.com',
		stories: [
			{ 
				headline: "More lorem ipsum passages",
				content: "Lorem ipsum dolor..."
			},
			{
				headline: "Another lorem ipsum passage",
				content: "Lorem ipsum dolor..."
			}
		]
	},
	{ 
		email: 'jane.smith@example.com',
		stories: [
			{ 
				headline: "Another lorem ipsum passage",
				content: "Lorem ipsum dolor..."
			},
			{
				headline: "The best of lorem ipsum",
				content: "Lorem ipsum dolor..."
			}
		]
	}
]
</code></pre>

<p>Would love to hear your questions or solutions: josephmosby@gmail.com</p>

		<a class="twitter-share-button" href="http://twitter.com/share" data-url="http://josephmosby.com/2015/06/23/a-good-cs-undergraduate-algorithm-problem.html" data-via="josephmosby">Tweet</a>
	</div>
</div>

<div class="row">
	<div class="col-3">
		<a href="/2015/06/09/einstein-blinked.html"><h3>Einstein blinked</h3></a>
		<div class="date">June 09, 2015</div>
	</div>
	<div class="col-8">
		<p>It’s the mid-1920s, and a patent clerk from Bern, Switzerland has just rocked the entire physics world with a proof sent to the German Academy of Sciences claiming that our notion of time is relative to the person observing it, and changes if you’re going really, really fast. Not satisfied with this absolutely insane discovery, this very same amateur physicist has the audacity to prove that if you’re in the presence of something huge, your notion of time will change as well. And then just for kicks he proves that light bends around super-huge objects like the time-warping ones. </p>

<p>In short, 1920s Albert Einstein was basically the physics-addicted love child of Elon Musk and Steve Jobs and Drake, with Richard Branson’s hair. He’s crazy talented and he is on every paper imaginable, because it’s the 1920s and no one has anything but dubious investments and bootleg liquor and science in their minds. It’s a brave new world out there.</p>

<p>Einstein’s cooking on the next big thing at this point. He’s proven what happens to Newton’s laws of physics when you’re in the presence of extraordinarily massive objects, but he’s only worked out the details by studying the effects of a single large object at a time. He’s decided it’s time to develop the equations to extrapolate all of this on a universal scale. He’s humming along, approving patents and mathematical equations and just being a general and special relative physical badass, when suddenly he hits an equation that he wasn’t expecting. He realizes that if all of his math checks out, then it implies that the universe must be either expanding or shrinking, but it cannot be a constant size. And he stares, and he ponders, and he thinks some more.</p>

<p>And Einstein blinks.</p>

<p>The idea of a non-constant universe overloads his mind and offends his conception of the world around him. He can’t handle it. He checks the math again and again and realizes that it always checks out, so he <em>changes the equations.</em> He adds the notion of a “cosmological constant,” which is supposed to represent the constant size of the universe or something. It’s total nonsense, naturally, and it takes twelve years for Edwin Hubble to finally have sensitive enough instruments to test the theory that the universe might be expanding after all. Hubble’s discoveries humble Einstein, and he deems the lost years to be the biggest blunder of his life. </p>

<p>Einstein recovers and goes on to make still more contributions to science, and few remember that he once had a totally wrong notion of a constant size to the universe. We remember his ideas on light, and gravity, and time, and still credit him with opening the door to the idea that the universe is expanding. Not with being wrong for twelve straight years.</p>


		<a class="twitter-share-button" href="http://twitter.com/share" data-url="http://josephmosby.com/2015/06/09/einstein-blinked.html" data-via="josephmosby">Tweet</a>
	</div>
</div>

<div class="row">
	<div class="col-3">
		<a href="/2015/06/03/you-should-probably-stop-reading-and-going-to-meetups.html"><h3>You should probably stop reading and stop going to meetups</h3></a>
		<div class="date">June 03, 2015</div>
	</div>
	<div class="col-8">
		<pre><code>When nothing is owed or deserved or expected
And your life doesn't change by the man that's elected
If you're loved by someone, you're never rejected
Decide what to be and go be it
- The Avett Brothers, "Head Full of Doubt/Road Full of Promise"
</code></pre>

<p>In November-ish of last year, I was lost. Not the sad sort of lost where you’re wandering around in a daze, but a sort of musingly confused lost. I had experienced a spurt of crazy personal growth while moonlighting for <a href="http://routeam.com">Routeam</a> that had propelled me forward as an engineer, then experienced another spurt when I took my first full-time front-end engineering role, but I hadn’t had anything after that for almost eight months. I no longer felt like I was producing excellent work that was pushing me forward. </p>

<p>Around that time, I asked a mentor (name changed to Dave to protect the innocent) for help. I cannot be thankful enough to Dave for this - he did not know me very well but was still willing to take some time out of his day to talk career advice with a budding engineer. I’m paraphrasing our conversation below to get to the good parts:</p>

<pre><code>Joe: Dave, I built a v1 of a startup product about a year ago, I've built some reasonably complex Python projects since then, I'm not a bad front-end engineer, but I'm stuck. How do I get to the next level as an engineer? What do I need to read or study to move forward? 

Dave: Stop going to meetups, and stop reading a bunch of stuff on the Internet. Go talk to people, and go build things. 
</code></pre>

<p>The dichotomy between where I was mentally and where I needed to be could not be more stark. At the time, I was lost because I wanted there to be some how-to guide, some magic blog post that I’d read on the Internet that could tell me where to go. I think those things are amazing for engineers as they’re starting out in their careers, but eventually you have to graduate past them. You have to pick something <em>you</em> love doing, and you have to go do it. </p>

<p>Meetups get in your way here. You start going to meetups with the purest of intentions. You want to learn about new technical topics (good) and you want to meet new people in the technology scene (good). But eventually they turn on you. You start to realize that you’ve accumulated enough expertise in a meetup’s subject matter that you’re not learning anything new, and you start to realize that the same people are showing up to the same meetups. <em>You do not have time for this.</em> You need to be building things.</p>

<p>Reading gets in your way here too. When you’re in this mental state of limbo, your reading choices start to represent that mental state. You slowly shift away from “I’m going to hunt for this bit on cybersecurity in Django that would help me with a project RIGHT NOW” to “I should read about Clojure. I don’t know how to program in Clojure and I don’t have any serious plans to learn, but I should read about it.” Your reading becomes a way to dodge taking real action. </p>

<p>To advance past this mental state, you have to make a choice. You have to choose something that you’re going to invest in, and you need to double down. It might be learning a brand new language, or a new framework, or a new use case for a language you already know. Whatever you choose, it’s going to require a lot of dedicated cognitive resources. And meetups and scatterbrained reading will suck up those cognitive resources. </p>

<p>So if you’re in that mental place, I urge you - pick up a hard problem. Turn off the distractions to solve it. That’s the only way to break through.</p>

		<a class="twitter-share-button" href="http://twitter.com/share" data-url="http://josephmosby.com/2015/06/03/you-should-probably-stop-reading-and-going-to-meetups.html" data-via="josephmosby">Tweet</a>
	</div>
</div>

<div class="row">
	<div class="col-3">
		<a href="/2015/05/29/chip-economics.html"><h3>Chip Economics</h3></a>
		<div class="date">May 29, 2015</div>
	</div>
	<div class="col-8">
		<p>Over the past few weeks, I’ve been working through <a href="http://nand2tetris.org">NAND2Tetris</a> after the recommendation of <a href="http://juliangindi.com/">Julian Gindi</a>. The NAND2Tetris course takes a single NAND electronic gate, which returns 0 if both inputs are 1 and returns 1 otherwise, and uses this as a building block for a whole host of electronic gates. It’s possible to make a NOT gate out of NAND chips. It’s also possible to build a multiplexer (which picks between inputs based on a control input). And most impressively, we can build an arithmetic logic unit - the core part of a CPU responsible for addition and subtraction - solely out of a stack of NAND chips. When all is said and done, I’ll have built a working computer emulator solely out of these single atomic pieces.</p>

<p>Now, at this point in computer development, I’ve never even <em>seen</em> a real NAND hardware chip, and it’s likely impossible I could see one even if you held it up. They’ve now been shrunk down to a few nanometers wide. Engineers at Intel and AMD obsess over ALU design (I expect, maybe even they don’t any more), but it’s so far abstracted away from my day-to-day work that I could get away with never knowing how one worked for my entire career. But once upon a time, that wasn’t the case. Chips were things you could actually touch, and solder onto a breadboard, and make arcade games out of them. </p>

<p>This exercise has made me look at some of the feats of early computer engineers in a totally different light. In the 1970s, Steve Wozniak was building Pong and <a href="http://thedoteaters.com/?bitstory=breakout">Breakout!</a> arcade games out of hardware chips, soldering together [more sophisticated] logic gates to build games. Atari was willing to pay $5000 ($22K in today’s dollars) for a Breakout chip design that only used 44 chips because chips actually cost enough for that to matter. Logic gates weren’t just vague ideas embedded into processor designs - they were things you could touch, and they cost money. </p>

		<a class="twitter-share-button" href="http://twitter.com/share" data-url="http://josephmosby.com/2015/05/29/chip-economics.html" data-via="josephmosby">Tweet</a>
	</div>
</div>

<div class="row">
	<div class="col-3">
		<a href="/2015/05/13/preventing-file-dupes-in-django.html"><h3>Preventing file dupes in files uploaded through Django</h3></a>
		<div class="date">May 13, 2015</div>
	</div>
	<div class="col-8">
		<p>Many Django applications make use of uploaded files that should never be re-uploaded again after they’ve been uploaded once. An example of this in action might be an image (one image embedded in a blog post might not be a big deal for a small site, but news sites often deal with licensed high-definition images used across several stories) or a large PDF with associated metadata (once the metadata is keyed in once, users shouldn’t be asked to do so again). Let’s talk about two design patterns to handle files, and ways we can deal with duplicates in each one. </p>

<h3 id="the-attachment">The Attachment</h3>

<p>With the Attachment design pattern, a file is part of the model as a Django <a href="https://docs.djangoproject.com/en/1.8/ref/models/fields/#django.db.models.FileField">FileField</a>. This is useful if the file to be attached is known ahead of time and will be of a semi-predictable type (for example, a press release for a scheduled report that will be in PDF format). Two or three additional users may be writing blog posts on the report, and each of them plan to attach the report as well. We don’t want to store a stack of extra copies of the file on the server - so how can we de-dupe them?</p>

<p>Our post is set up like so:</p>

<pre><code>from django.db import models

class ReportPost(models.Model):
	file = models.FileField()
	file_sha1 = models.CharField(max_length=40)
	post_text = models.TextField()

	... etc ...
</code></pre>

<p>Our <code>ReportPost</code> has space for an uploaded file. We also have a <code>sha1</code> field here. Django can’t automatically detect a duplicate file (<code>unique</code> is not supported for <code>FileFields</code> or any derivatives), so we need to take the SHA-1 text hash of the file in order to check if it’s been uploaded already. We’ll take care of that in the <code>ModelAdmin</code> for this model.</p>

<pre><code>from django.contrib import admin
import hashlib

def generate_sha(file):
	sha = hashlib.sha1()
	file.seek(0)
	while True:
		buf = file.read(104857600)
		if not buf:
			break
		sha.update(buf)
	sha1 = sha.hexdigest()
	file.seek(0)

	return sha1

class ReportPostAdmin(admin.ModelAdmin):
	... stuff ...

	def save_model(self, request, obj, form, change):
		sha = generate_sha(obj.file)
		obj.file_sha1 = sha
		match_qs = ReportPost.objects.filter(file_sha1=sha)
		if match_qs.count() &gt; 0:
			obj.file = match_qs[0].file

		obj.save()
</code></pre>

<p>We derive a SHA-1 hash for this file by reading in the first 100 megabytes of data and hashing it. In our <code>ModelAdmin.save_model</code> method, we store that SHA-1 with our model instance. We also run a query against the database for any model instances with that exact same SHA-1 (indicating a match), and replace our instance of the file with the previously uploaded file. </p>

<h3 id="the-file-as-object">The File as Object</h3>

<p>With this design pattern, files are part of a larger object that gives them relevance. Images in a newsroom app, for example, come with credits, licensing information, and various data about how often the image is used. In order to store that metadata about that image, we need a file object.</p>

<pre><code># models.py

class ImageObject(models.Model):
	caption = models.CharField(max_length=140)
	credits = models.CharField(max_length=140)
	image_file = models.ImageField()
	file_sha1 = models.CharField(max_length=40, unique=True)

# admin.py

class ImageObjectAdmin(admin.ModelAdmin):
	... stuff ...

	def save_model(self, request, obj, form, change):
		sha = generate_sha(obj.file)
		obj.file_sha1 = sha
		obj.save()
</code></pre>

<p>With this example, we add some uniqueness to our model, which gives us the ability to easily enforce that each image file will only have one set of metadata. Our app will throw an <code>IntegrityError</code> if a user tries to save a duplicate SHA-1 hash. We’ll need to handle that <code>IntegrityError</code> and redirect our user to the previously uploaded image. We can do that using a new middleware object.</p>

<p>Middleware objects in Django quietly do their thing 99.9% of the time, and you’ll never think twice about them. They’re there for session authentication or CSRF enforcement - things that most of us take for granted. But you can easily add your own middleware with ease by adding a <code>middleware.py</code> file to your application and registering it with <code>settings.py</code>:</p>

<pre><code># settings.py

MIDDLEWARE_CLASSES = (
	'django.contrib.sessions.middleware.SessionMiddleware',
	... stuff ...
	'our_image_app.middleware.RedirectOnSHAViolation',
)
</code></pre>

<p>And then in <code>our_image_app/middleware.py</code>:</p>

<pre><code># middleware.py

from django.db import IntegrityError
from django.http import HttpResponseRedirect
from utils import generate_sha # same func as before
from our_image_app.models import ImageObject

class RedirectOnSHAViolation():
	def process_exception(self, request, exception):
		if type(exception) == IntegrityError:
			if "our_image_app/imageobject" in request.path:
				sha1 = generate_sha1(request.FILES['image_file'])
				img = ImageObject.objects.get(file_sha1=sha1)
				return HttpResponseRedirect('/admin/our_image_app/imageobject/') + str(img.id))
</code></pre>

<p>I never said it was pretty.</p>

<p>Django’s middleware system expects to see a class with a <code>process_exception</code> method that’s really, really stupid. The middleware knows it has a request that caused an error, but that’s about all that it knows. We have to do two checks to make sure that we’re handling the right error here. First, we check that the <code>type</code> of error is <code>IntegrityError</code>. We have to run this check first because every single error in our app could potentially hit this method, so we need to filter for only certain types. Once I’ve confirmed that, I check to see if the <code>IntegrityError</code> came from the <code>ImageObject</code> model within <code>our_image_app</code> - and since <code>ImageObject</code> only has one unique field, I know an <code>IntegrityError</code> here must be a duplicate file. Once I’ve ascertained all of that, then I need to find the file I should have used and redirect the user there instead.</p>

<h3 id="conclusions">Conclusions</h3>

<p>SHA-1 hashes provide an easy way to compensate for Django FileFields’ inability to enforce uniqueness by default. Handling those errors can be a bit messy, but we can create some custom middleware to handle any problems or extend our admin’s built-in methods to help us out.</p>

<p><em>Props to <a href="https://twitter.com/spiggy">@spiggy</a>, who had the original idea of using SHAs to look for duplicate files.</em></p>

		<a class="twitter-share-button" href="http://twitter.com/share" data-url="http://josephmosby.com/2015/05/13/preventing-file-dupes-in-django.html" data-via="josephmosby">Tweet</a>
	</div>
</div>


<div class="row">
	<div class="col-offset-3 col-8">
		<div class="pagination">
			
			<a href="/page2" class="previous">Previous</a>
			

			<span class="page_number">Page: 3 of 9</span>

			
			<a href="/page4" class="next">Next</a>
			
		</div>
	</div>
</div>
			</div>
		</div>

		<div class="wrapper" id="footer">
			<div class="container">
				<div class="row">
					<div class="col-13">
						<p>Brought to you live from Washington, D.C.</p>
					</div>
				</div>
			</div>
		</div>

		<script src="app.js"></script>

		<script>
	
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-45638065-1', 'josephmosby.com');
	    ga('send', 'pageview');
	  
	  	</script>

  		<script>
		window.twttr=(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return;js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);t._e=[];t.ready=function(f){t._e.push(f);};return t;}(document,"script","twitter-wjs"));
		</script>

	</body>

</html>